# LocalPotato - CVE-2023-21746

{% embed url="https://github.com/decoder-it/LocalPotato" %}

### NTLM Authentication

The usual case of NTLM authentication involves a user trying to authenticate to a remote server. Three packets are involved in the authentication process:

* **Type 1 Message** : The client sends a packet to negotiate the terms of the authentication process. The packet optionally contains the name of the client machine and its domain. The server receives the packet and can check that authentication was started from a different machine.
* **Type 2 Message** : The server responds to the client with a challenge. The "challenge" is a random number used to authenticate the client without having to pass their credentials through the network.
* **Type 3 Message** : The client uses the challenge received on the Type 2 message and combines it with the user's password hash to generate a response to the challenge. The response is sent to the server as part of the Type 3 message. That way, the server can check if the client knows the correct user's password hash without transferring it through the network.

<figure><img src="../../../../.gitbook/assets/image (6) (1).png" alt="" width="557"><figcaption></figcaption></figure>

### NTLM Local Authentication

NTLM local authentication is used when a user tries to log into a service running on the same machine. Since both the client and server applications reside on the same machine, there is no need for the challenge-response process. Authentication is instead performed differently by setting up a Security Context. While we won't dive into the details of what is contained in a Security Context, think of it as a set of security parameters associated with a connection, including the session key and the user whose privileges will be used for the connection.

The process still involves the same three messages as before, but the information used for authentication changes as follows:

* **Type 1 Message** : The client sends this message to start the connection. It is used to negotiate authentication parameters just like before but also contains the name of the client machine and its domain. The server can check the client's name and domain, and the local authentication process begins if they match their own.
* **Type 2 Message** : The server creates a Security Context and sends back its ID to the client in this message. The client can then use the Security Context ID to associate
* **Type 3 Message** : If the client successfully associates themselves with an existing Security Context ID, an empty Type 3 message is sent back to the server to signal that the local authentication process succeeded.

<figure><img src="../../../../.gitbook/assets/image (1) (1).png" alt="" width="556"><figcaption></figcaption></figure>

### LocalPotato Exploit

The process followed by the exploit is as follows:

* The attacker will **trigger a privileged process** to connect to a **rogue** **server** under his control. This works similarly to previous Potato exploits, where an unprivileged user can force the Operating System into creating connections that use a privileged user (usually SYSTEM).
* The **rogue** **server** will **instantiate** a **Security** **Context** **A** for the **privileged** **connection** but won't send it back immediately. Instead, the **attacker** will launch a **rogue** **client** that **simultaneously** **initiates** **a connection against the local SMB Server** (Windows File Sharing) with its current unprivileged credentials. The client will send the Type1 message to initiate the connection, and the server will reply by sending a Type2 message with the ID for a new Security Context B.
* The attacker will swap the Context IDs from both connections so that the privileged process receives the context of the SMB server connection instead of its own. As a result, the Privileged client will associate its user (SYSTEM) with Security Context B of the SMB connection created by the attacker. As a result, the attacker's client can now access any network share with SYSTEM privileges!

<figure><img src="../../../../.gitbook/assets/image (5) (1).png" alt="" width="563"><figcaption></figcaption></figure>

### StorSvc and DLL Hijacking

{% embed url="https://decoder.cloud/2023/02/13/localpotato-when-swapping-the-context-leads-you-to-system/" %}

{% embed url="https://tryhackme.com/room/localpotato" %}
